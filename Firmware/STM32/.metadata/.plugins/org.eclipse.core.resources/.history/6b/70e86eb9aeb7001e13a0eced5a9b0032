/*
 * EEPROM.c
 *
 *  Created on: Jan 20, 2024
 *      Author: bens1
 */

#include "EEPROM.h"

#ifdef M24256X
#include "M24256X.h"
#endif

EEPROM_StatusTypeDef EEPROM_Init(EEPROM_HandleTypeDef *dev, I2C_HandleTypeDef *i2cHandle){

#ifdef M24256X
	return M24256X_Init(dev, i2cHandle);
#endif
}

EEPROM_StatusTypeDef EEPROM_WriteMemoryByte(EEPROM_HandleTypeDef *dev, uint16_t address, uint8_t *data){

#ifdef M24256X
	return M24256X_WriteMemoryByte(dev, address, data);
#endif
}

EEPROM_StatusTypeDef EEPROM_WriteMemoryByte(EEPROM_HandleTypeDef *dev, uint16_t address, uint8_t *data){

#ifdef M24256X
	return M24256X_ReadMemoryByte(dev, address, data);
#endif
}

/*
 * M24256X.c
 *
 *  Created on: Jan 18, 2024
 *      Author: bens1
 */

#include "M24256X.h"

M24256X_StatusTypeDef M24256X_Init(M24256X_HandleTypeDef *dev, I2C_HandleTypeDef *i2cHandle){

	M24256X_StatusTypeDef status = M24256X_OK;

	/* Assign I2C handle */
	dev->i2cHandle = i2cHandle;

	return status;
}

M24256X_StatusTypeDef EEPROM_ReadMemoryByte(M24256X_HandleTypeDef *dev, uint16_t address, uint8_t *data){

	M24256X_StatusTypeDef status = M24256X_OK;
	uint8_t attempts_remaining = M24256X_MAX_ATTEMPTS;

	while (attempts_remaining > 0){
		status = HAL_I2C_Mem_Read(dev->i2cHandle, M24256X_MEM_DEV_ADDR, (address & 0x7FFF), I2C_MEMADD_SIZE_16BIT, data, 1, HAL_MAX_DELAY);

		if (status == M24256X_OK){
			attempts_remaining = 0;
		}
		else{
			attempts_remaining--;
		}
	}

	return status;
}

M24256X_StatusTypeDef EEPROM_WriteMemoryByte(M24256X_HandleTypeDef *dev, uint16_t address, uint8_t *data){

	M24256X_StatusTypeDef status = M24256X_OK;
	uint8_t attempts_remaining = M24256X_MAX_ATTEMPTS;

	while (attempts_remaining > 0){
		status = HAL_I2C_Mem_Write(dev->i2cHandle, M24256X_MEM_DEV_ADDR, (address & 0x7FFF), I2C_MEMADD_SIZE_16BIT, data, 1, HAL_MAX_DELAY);

		if (status == M24256X_OK){
			attempts_remaining = 0;
		}
		else{
			attempts_remaining--;
		}
	}

	return status;
}
